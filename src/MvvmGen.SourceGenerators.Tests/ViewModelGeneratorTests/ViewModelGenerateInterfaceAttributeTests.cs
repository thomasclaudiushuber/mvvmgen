// ***********************************************************************
// ⚡ MvvmGen => https://github.com/thomasclaudiushuber/mvvmgen
// Copyright © by Thomas Claudius Huber
// Licensed under the MIT license => See LICENSE file in repository root
// ***********************************************************************

using Xunit;

namespace MvvmGen.SourceGenerators
{
    public class ViewModelGenerateInterfaceAttributeTests : ViewModelGeneratorTestsBase
    {
        [Fact]
        public void GenerateInterfaceWithMembers()
        {
            ShouldGenerateExpectedCode(
      $@"using MvvmGen;

namespace MyCode
{{
  [ViewModelGenerateInterface]
  [ViewModel]
  public partial class EmployeeViewModel
  {{
    [Property] string _firstName;

    [Property] public partial string MiddleName {{ get; set; }}

    public string LastName {{ get; set; }}

    public string FullName => FirstName + "" "" + LastName;

    public void CustomMethod() {{ }}

    public bool CustomMethodWithParameters(string name, int age) {{ }}
  }}
}}",
      $@"{AutoGeneratedTopContent}

namespace MyCode
{{
    partial class EmployeeViewModel : global::MvvmGen.ViewModels.ViewModelBase, IEmployeeViewModel
    {{
        public EmployeeViewModel()
        {{
            this.OnInitialize();
        }}

        partial void OnInitialize();

        public string FirstName
        {{
            get => _firstName;
            set
            {{
                if (_firstName != value)
                {{
                    _firstName = value;
                    OnPropertyChanged(""FirstName"");
                }}
            }}
        }}

        private string _middleName;

        public partial string MiddleName
        {{
            get => _middleName;
            set
            {{
                if (_middleName != value)
                {{
                    _middleName = value;
                    OnPropertyChanged(""MiddleName"");
                }}
            }}
        }}
    }}

    public interface IEmployeeViewModel : System.ComponentModel.INotifyPropertyChanged
    {{
        string FirstName {{ get; set; }}
        string MiddleName {{ get; set; }}
        string LastName {{ get; set; }}
        string FullName {{ get; }}
        void CustomMethod();
        bool CustomMethodWithParameters(string name, int age);
    }}
}}
");
        }

        [Fact]
        public void GenerateInterfaceWithMembersFromModel()
        {
            ShouldGenerateExpectedCode(
    $@"using MvvmGen;

namespace MyCode
{{
    public class Employee
    {{
        public string FirstName {{ get; set; }}
        public bool IsDeveloper {{ get; set; }}
    }}

    [ViewModelGenerateInterface]
    [ViewModel(typeof(Employee))]
    public partial class EmployeeViewModel
    {{
    }}
}}",
    $@"{AutoGeneratedTopContent}

namespace MyCode
{{
    partial class EmployeeViewModel : global::MvvmGen.ViewModels.ViewModelBase, IEmployeeViewModel
    {{
        public EmployeeViewModel()
        {{
            this.OnInitialize();
        }}

        partial void OnInitialize();

        public string FirstName
        {{
            get => Model.FirstName;
            set
            {{
                if (Model.FirstName != value)
                {{
                    Model.FirstName = value;
                    OnPropertyChanged(""FirstName"");
                }}
            }}
        }}

        public bool IsDeveloper
        {{
            get => Model.IsDeveloper;
            set
            {{
                if (Model.IsDeveloper != value)
                {{
                    Model.IsDeveloper = value;
                    OnPropertyChanged(""IsDeveloper"");
                }}
            }}
        }}

        protected MyCode.Employee Model {{ get; set; }}
    }}

    public interface IEmployeeViewModel : System.ComponentModel.INotifyPropertyChanged
    {{
        string FirstName {{ get; set; }}
        bool IsDeveloper {{ get; set; }}
    }}
}}
");
        }

        [Fact]
        public void GenerateInterfaceWithCommandProperty()
        {
            ShouldGenerateExpectedCode(
    $@"using MvvmGen;

namespace MyCode
{{
    [ViewModelGenerateInterface]
    [ViewModel]
    public partial class EmployeeViewModel
    {{
        [Command]
        public void Save() {{ }}
    }}
}}",
    $@"{AutoGeneratedTopContent}

namespace MyCode
{{
    partial class EmployeeViewModel : global::MvvmGen.ViewModels.ViewModelBase, IEmployeeViewModel
    {{
        private IDelegateCommand? _saveCommand;

        public EmployeeViewModel()
        {{
            this.OnInitialize();
        }}

        partial void OnInitialize();

        public IDelegateCommand SaveCommand => _saveCommand ??= new DelegateCommand(_ => Save());
    }}

    public interface IEmployeeViewModel : System.ComponentModel.INotifyPropertyChanged
    {{
        IDelegateCommand SaveCommand {{ get; }}
        void Save();
    }}
}}
");
        }

        [Fact]
        public void GenerateInterfaceWithCustomName()
        {
            ShouldGenerateExpectedCode(
    $@"using MvvmGen;

namespace MyCode
{{
    [ViewModelGenerateInterface(InterfaceName=""ICustomInterfaceName"")]
    [ViewModel]
    public partial class EmployeeViewModel
    {{
    }}
}}",
    $@"{AutoGeneratedTopContent}

namespace MyCode
{{
    partial class EmployeeViewModel : global::MvvmGen.ViewModels.ViewModelBase, ICustomInterfaceName
    {{
        public EmployeeViewModel()
        {{
            this.OnInitialize();
        }}

        partial void OnInitialize();
    }}

    public interface ICustomInterfaceName : System.ComponentModel.INotifyPropertyChanged
    {{
    }}
}}
");
        }

        [InlineData("", " : global::MvvmGen.ViewModels.ViewModelBase, IEmployeeViewModel")]
        [InlineData(" : MvvmGen.ViewModels.ViewModelBase", " : IEmployeeViewModel")]
        [Theory]
        public void ViewModelShouldExtendInterface(string inputExtendString, string expectedGeneratedExtendString)
        {
            ShouldGenerateExpectedCode(
      $@"using MvvmGen;

namespace MyCode
{{
  [ViewModelGenerateInterface]
  [ViewModel]
  public partial class EmployeeViewModel{inputExtendString}
  {{
  }}
}}",
      $@"{AutoGeneratedTopContent}

namespace MyCode
{{
    partial class EmployeeViewModel{expectedGeneratedExtendString}
    {{
        public EmployeeViewModel()
        {{
            this.OnInitialize();
        }}

        partial void OnInitialize();
    }}

    public interface IEmployeeViewModel : System.ComponentModel.INotifyPropertyChanged
    {{
    }}
}}
");
        }

        [Fact]
        public void GenerateInterfaceWithGenericMethod()
        {
            ShouldGenerateExpectedCode(
    $@"using MvvmGen;

namespace MyCode
{{
    [ViewModelGenerateInterface]
    [ViewModel]
    public partial class EmployeeViewModel
    {{
        public void MyMethod<T>(T item)
        {{
        }}
    }}
}}",
    $@"{AutoGeneratedTopContent}

namespace MyCode
{{
    partial class EmployeeViewModel : global::MvvmGen.ViewModels.ViewModelBase, IEmployeeViewModel
    {{
        public EmployeeViewModel()
        {{
            this.OnInitialize();
        }}

        partial void OnInitialize();
    }}

    public interface IEmployeeViewModel : System.ComponentModel.INotifyPropertyChanged
    {{
        void MyMethod<T>(T item);
    }}
}}
");
        }

        [Fact]
        public void GenerateInterfaceWithGenericMethodWithOneTypeConstraint()
        {
            ShouldGenerateExpectedCode(
    $@"using MvvmGen;

namespace MyCode
{{
    [ViewModelGenerateInterface]
    [ViewModel]
    public partial class EmployeeViewModel
    {{
        public void MyMethod<T>(T item) where T : new()
        {{
        }}
    }}
}}",
    $@"{AutoGeneratedTopContent}

namespace MyCode
{{
    partial class EmployeeViewModel : global::MvvmGen.ViewModels.ViewModelBase, IEmployeeViewModel
    {{
        public EmployeeViewModel()
        {{
            this.OnInitialize();
        }}

        partial void OnInitialize();
    }}

    public interface IEmployeeViewModel : System.ComponentModel.INotifyPropertyChanged
    {{
        void MyMethod<T>(T item) where T : new();
    }}
}}
");
        }

        [Fact]
        public void GenerateInterfaceWithGenericMethodWithTwoTypeConstraints()
        {
            ShouldGenerateExpectedCode(
    $@"using MvvmGen;

namespace MyCode
{{
    [ViewModelGenerateInterface]
    [ViewModel]
    public partial class EmployeeViewModel
    {{
        public void MyMethod<K, V>(K key, V value) where K : new()
                                                   where V : class
        {{
        }}
    }}
}}",
    $@"{AutoGeneratedTopContent}

namespace MyCode
{{
    partial class EmployeeViewModel : global::MvvmGen.ViewModels.ViewModelBase, IEmployeeViewModel
    {{
        public EmployeeViewModel()
        {{
            this.OnInitialize();
        }}

        partial void OnInitialize();
    }}

    public interface IEmployeeViewModel : System.ComponentModel.INotifyPropertyChanged
    {{
        void MyMethod<K, V>(K key, V value) where K : new() where V : class;
    }}
}}
");
        }
    }
}
